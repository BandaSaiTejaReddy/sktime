# adapted from
# - https://github.com/scikit-hep/azure-wheel-helpers/blob/master/azure-manylinux-wheels.yml

steps:
    # run bash script inside docker image with
    # passed variables and linked directory
    - script: |
        docker run --rm \
          -e NPY_NUM_BUILD_JOBS=4 \
          -e PLATFORM="$(PLATFORM)" \
          -e REQUIREMENTS="$(REQUIREMENTS)" \
          -e EXCLUDE_PYTHON_VERSIONS="$(EXCLUDE_PYTHON_VERSIONS)" \
          -e TEST_DIR="$(TEST_DIR)" \
          -e PYTEST_RESULTS="$(PYTEST_RESULTS)" \
          -v "$PWD":/io \
          "$(IMAGE)" \
          /io/build_tools/azure/build_wheels.sh
      displayName: 'Build and test wheels'

    - task: PublishTestResults@2
      displayName: 'Publish test results'
      inputs:
        testResultsFiles: '$(TEST_DIR)/$(PYTEST_RESULTS)'
        testRunTitle: ${{ format('{0}-$(Agent.JobName)', parameters.name) }}
      condition: succeededOrFailed()

